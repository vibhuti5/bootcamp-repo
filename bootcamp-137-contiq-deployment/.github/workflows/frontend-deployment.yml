name: Bootcamp137 - Frontend deployment on Azure
run-name: Frontend deployment update triggered by ${{ github.actor }}.
on:
  push:
    branches:
      - deployment
    paths:
      - frontend/**
      - .github/workflows/frontend-deployment.yml
      - "!frontend/src/data/"

permissions:
  id-token: write
  contents: write

jobs:
  frontend-build-push:
    name: Build and Push the frontend docker image
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache node_modules
        uses: actions/cache@v2
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package.json') }}

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm install --legacy-peer-deps

      - name: Retrieve the env vars
        run: echo "${{ secrets.FE_ENV }}" > .env

      - name: Build application
        run: npm run build

      - name: Fetch secrets from Azure Keyvault
        uses: zemoso-int/get-keyvault-secrets@master
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          keyvault: bootcamp-137
          secrets: |
            REGISTRY_LOGIN_SERVER=registry-login-server
            REGISTRY_USERNAME=registry-username
            REGISTRY_PASSWORD=registry-password

      - name: "Docker Login"
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY_LOGIN_SERVER }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build the frontend image and push it to ACR
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ env.REGISTRY_LOGIN_SERVER }}/bootcamp137-frontend:${{ github.sha }}
          context: frontend

  frontend-update-manifest:
    name: Update the frontend deployment manifest with latest docker image
    needs: frontend-build-push
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: kubernetes-manifests/deployments
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Fetch secrets from Azure Keyvault
        uses: zemoso-int/get-keyvault-secrets@master
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          keyvault: bootcamp-137
          secrets: |
            REGISTRY_LOGIN_SERVER=registry-login-server

      - name: Update image tag
        run: |
          sed -i 's|image: .*|image: ${{ env.REGISTRY_LOGIN_SERVER }}/bootcamp137-frontend:${{ github.sha }}|' fe-deploy.yml

      - name: Get the Commit author email
        run: |
          git fetch origin ${GITHUB_REF:11} # fetches the branch
          EMAIL=$(git log -1 --pretty=format:'%ae' HEAD)

      - name: Commit the changes
        run: |
          set -x
          cd ${{github.workspace}}
          git config --local user.email "$EMAIL"
          git config --local user.name ${{ github.actor }}
          git pull origin deployment
          git commit -am "Update image tag to ${{ github.sha }}"
          git push -u origin deployment
